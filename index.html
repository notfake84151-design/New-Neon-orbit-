<!DOCTYPE html>
<html>
<head>
    <title>Neon Orbit: Final Fixed Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; touch-action: none; color: white; }
        canvas { display: block; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: none; z-index: 100; }
        .menu-card { background: rgba(0,0,0,0.95); padding: 25px; border-radius: 20px; border: 2px solid #0ff; text-align: center; pointer-events: auto; min-width: 270px; box-shadow: 0 0 20px #0ff; }
        .btn { background: #0ff; border: none; padding: 12px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; margin: 10px; font-weight: bold; color: black; }
        #stats { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-around; font-size: 14px; font-weight: bold; pointer-events: none; color: #0ff; z-index: 10; }
        .skin-btn { background: #333; color: white; border: 1px solid #555; padding: 8px; margin: 3px; border-radius: 5px; font-size: 11px; }
        .active-skin { border-color: #0ff; background: #004444; }
        .ad-btn { background: #ffcc00; color: #000; padding: 10px; border-radius: 10px; margin-top: 15px; cursor: pointer; font-weight: bold; font-size: 12px; display: block; width: 80%; margin-left: auto; margin-right: auto; }
        #pauseBtn { position: absolute; bottom: 20px; right: 20px; pointer-events: auto; background: rgba(0,255,255,0.2); color: #0ff; border: 2px solid #0ff; border-radius: 50%; width: 55px; height: 55px; font-size: 22px; z-index: 200; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="stats">
        <div>SCORE: <span id="scoreVal">0</span></div>
        <div>STARS: <span id="starsVal">0</span></div>
        <div>BEST: <span id="highScoreVal">0</span></div>
    </div>

    <button id="pauseBtn" onclick="togglePause()">II</button>

    <div id="ui-layer">
        <div id="startMenu" class="menu-card">
            <h1 style="color:#0ff; margin:0;">NEON ORBIT</h1>
            <p style="font-size:12px;">Stable Version 2.0</p>
            <button class="btn" onclick="startGame()">START</button>
            <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                <p style="font-size:12px; margin:5px;">SKINS:</p>
                <button class="skin-btn active-skin" onclick="setSkin('circle', 0, this)">Circle</button>
                <button class="skin-btn" onclick="setSkin('square', 20, this)">Square (20â˜…)</button>
                <button class="skin-btn" onclick="setSkin('star', 50, this)">Star (50â˜…)</button>
                <div class="ad-btn" id="adBtn" onclick="watchAdForStars()">ðŸ“º WATCH AD FOR 10â˜…</div>
            </div>
        </div>

        <div id="gameOverMenu" class="menu-card hidden">
            <h1 style="color:#f0f; margin:0;">GAME OVER</h1>
            <p id="finalScoreText" style="margin:10px 0;"></p>
            <button class="btn" onclick="resetGame()">RESTART</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script src="cordova.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let audioCtx;
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        let score = 0, stars = parseInt(localStorage.getItem("neonStars")) || 0;
        let highScore = localStorage.getItem("neonBest") || 0;
        let gameActive = false, isPaused = false;
        let angle = 0, direction = 0.05, obstacles = [], starsItems = [], level = 1;
        let currentSkin = 'circle';
        let animationId, musicTimer;
        let isAdShowing = false;

        document.getElementById('highScoreVal').innerText = highScore;
        document.getElementById('starsVal').innerText = stars;

        document.addEventListener('deviceready', () => {
            if(window.admob) {
                admob.banner.config({ id: 'ca-app-pub-6713917529499757/7350741204' });
                admob.banner.prepare();
                admob.banner.show();
                admob.interstitial.config({ id: 'ca-app-pub-6713917529499757/2681800668' });
                admob.interstitial.prepare();
            }
        }, false);

        // --- FIXED STAR BUTTON (Anti-Cheat) ---
        function watchAdForStars() {
            if(isAdShowing) return;
            if(window.admob) {
                isAdShowing = true;
                admob.interstitial.show();
                
                // Reward only if ad is shown
                setTimeout(() => {
                    stars += 10;
                    localStorage.setItem("neonStars", stars);
                    document.getElementById('starsVal').innerText = stars;
                    admob.interstitial.prepare(); 
                    isAdShowing = false;
                    alert("Ads watched! 10 Stars added.");
                }, 2000); 
            } else {
                alert("Ad is loading... please wait 5 seconds.");
                if(window.admob) admob.interstitial.prepare();
            }
        }

        function playSfx(f, t, d, v, delay = 0) {
            if(!audioCtx || isPaused) return;
            try {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime + delay);
                g.gain.setValueAtTime(v, audioCtx.currentTime + delay);
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + delay + d);
                o.connect(g); g.connect(audioCtx.destination);
                o.start(audioCtx.currentTime + delay);
                o.stop(audioCtx.currentTime + delay + d);
            } catch(e) {}
        }

        function playMusic() {
            if(!gameActive || isPaused) return;
            playSfx(100, 'sine', 0.5, 0.1);
            musicTimer = setTimeout(playMusic, 1000 - (level * 15));
        }

        function setSkin(type, cost, btn) {
            if(stars >= cost) {
                currentSkin = type;
                document.querySelectorAll('.skin-btn').forEach(b => b.classList.remove('active-skin'));
                btn.classList.add('active-skin');
                playSfx(600, 'sine', 0.1, 0.1);
            } else { alert("Watch an Ad to get more stars!"); }
        }

        function togglePause() {
            if(!gameActive) return;
            isPaused = !isPaused;
            document.getElementById('pauseBtn').innerText = isPaused ? "â–º" : "II";
            if(!isPaused) { playMusic(); draw(); }
            else { clearTimeout(musicTimer); cancelAnimationFrame(animationId); }
        }

        function startGame() {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            document.getElementById('startMenu').classList.add('hidden');
            gameActive = true;
            isPaused = false;
            playMusic();
            spawnSystem();
            draw();
        }

        // --- FIXED RESTART (No Freeze) ---
        function resetGame() {
            gameActive = false;
            cancelAnimationFrame(animationId);
            clearTimeout(musicTimer);
            
            score = 0; level = 1; obstacles = []; starsItems = []; angle = 0;
            document.getElementById('scoreVal').innerText = "0";
            document.getElementById('gameOverMenu').classList.add('hidden');
            
            setTimeout(() => {
                gameActive = true;
                isPaused = false;
                playMusic();
                draw();
            }, 200);
        }       

        function spawnSystem() {
            if(!gameActive || isPaused) { setTimeout(spawnSystem, 500); return; }
            const side = Math.random() * Math.PI * 2;
            obstacles.push({ x: canvas.width/2 + Math.cos(side) * canvas.width, y: canvas.height/2 + Math.sin(side) * canvas.width, speed: 2 + (level * 0.4) });
            setTimeout(spawnSystem, Math.max(300, 1000 - (level * 50)));
        }

        function draw() {
            if (!gameActive || isPaused) return;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#333';
            ctx.beginPath(); ctx.arc(canvas.width/2, canvas.height/2, 70, 0, Math.PI*2); ctx.stroke();
            
            const px = canvas.width/2 + Math.cos(angle) * 70;
            const py = canvas.height/2 + Math.sin(angle) * 70;
            angle += direction;
            
            ctx.fillStyle = "#0ff"; ctx.beginPath();
            if(currentSkin === 'circle') ctx.arc(px, py, 10, 0, Math.PI*2);
            else if(currentSkin === 'square') ctx.rect(px-9, py-9, 18, 18);
            else for(let i=0; i<5; i++) ctx.lineTo(px+Math.cos((i*72-90)*Math.PI/180)*15, py+Math.sin((i*72-90)*Math.PI/180)*15);
            ctx.fill();

            obstacles.forEach((obs, i) => {
                const dx = canvas.width/2-obs.x, dy = canvas.height/2-obs.y, dist = Math.hypot(dx, dy);
                obs.x += (dx/dist)*obs.speed; obs.y += (dy/dist)*obs.speed;
                ctx.fillStyle = "#f0f"; ctx.fillRect(obs.x-6, obs.y-6, 12, 12);
                if (Math.hypot(px-obs.x, py-obs.y) < 15) gameOver();
                if (dist < 5) {
                    obstacles.splice(i, 1); score++;
                    document.getElementById('scoreVal').innerText = score;
                    if(score % 10 === 0) level++;
                }
            });
            if(gameActive) animationId = requestAnimationFrame(draw);
        }

        // --- FIXED GAMEOVER (Safe Exit) ---
        function gameOver() {
            gameActive = false;
            cancelAnimationFrame(animationId);
            clearTimeout(musicTimer);
            
            document.getElementById('finalScoreText').innerText = "SCORE: " + score;
            document.getElementById('gameOverMenu').classList.remove('hidden');
            
            if(score > highScore) { 
                highScore = score; 
                localStorage.setItem("neonBest", highScore); 
                document.getElementById('highScoreVal').innerText = highScore; 
            }

            setTimeout(() => {
                if(window.admob) {
                    admob.interstitial.show();
                    admob.interstitial.prepare();
                }
            }, 500);
        }

        window.addEventListener('touchstart', (e) => { 
            if(gameActive && !isPaused && e.target.id !== 'pauseBtn' && e.target.id !== 'adBtn') {
                direction *= -1;
            }
        });
    </script>
</body>
</html>


